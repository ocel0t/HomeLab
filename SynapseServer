### Synapse setup on a Debian virtual machine ###

### Docs: https://element-hq.github.io/synapse/latest/setup/installation.html ###

# Download pre-installed VmWare image
wget https://www.osboxes.org/debian/#debian-12-11-0-vmware

# Remove the default user and add a new one

sudo adduser ocel0t
sudo usermod -aG ocel0t sudo
sudo deluser osboxes

# Set networking to Bridged in VmWare

# Upgrade system and enable ssh

sudo apt update
sudo apt upgrade
sudo apt install openssh-server
sudo systemctl start ssh
sudo systemctl enable ssh

# Install Synapse debian package maintenade by matrix.org

sudo apt install -y lsb-release wget apt-transport-https
sudo wget -O /usr/share/keyrings/matrix-org-archive-keyring.gpg https://packages.matrix.org/debian/matrix-org-archive-keyring.gpg
gpg /usr/share/keyrings/matrix-org-archive-keyring.gpg # Checking depository signing key fingerprint
echo "deb [signed-by=/usr/share/keyrings/matrix-org-archive-keyring.gpg] https://packages.matrix.org/debian/ $(lsb_release -cs) main" |
    sudo tee /etc/apt/sources.list.d/matrix-org.list
sudo apt update
sudo apt install matrix-synapse-py3

# Installing and configuring PostgreSQL database

sudo apt install libpq5
sudo apt install postgresql postgresql-contrib
sudo systemctl start postgresql
sudo systemctl enable postgresql

sudo -u postgres bash
createuser --pwprompt synapse_user
createdb --encoding=UTF8 --locale=C --template=template0 --owner=synapse_user synapse

# Configuring Synapse

sudo nano /etc/matrix-synapse/homeserver.yaml

''' Change these arguments
database:
  name: psycopg2
  args:
    user: <user>
    password: <pass>
    dbname: <db>
    host: <host>
    cp_min: 5
    cp_max: 10
''''

# Checking the matrix-synapse service running, monitoring logs

sudo service matrix-synapse restart
sudo service matrix-synapse status
tail -f /var/log/matrix-synapse/homeserver.log

# Configuring a reverse proxy without SSL

sudo apt install apache2 # installing an apache2 web server

sudo nano /etc/apache2/sites-available/synapse.conf # creating virtual host configuration

'''CONTENT'''

<VirtualHost *:443>
    ServerName example.com # change here!

    RequestHeader set "X-Forwarded-Proto" expr=%{REQUEST_SCHEME}
    AllowEncodedSlashes NoDecode
    ProxyPreserveHost on
    ProxyPass /_matrix http://127.0.0.1:8008/_matrix nocanon
    ProxyPassReverse /_matrix http://127.0.0.1:8008/_matrix
    ProxyPass /_synapse/client http://127.0.0.1:8008/_synapse/client nocanon
    ProxyPassReverse /_synapse/client http://127.0.0.1:8008/_synapse/client
</VirtualHost>

<VirtualHost *:8448>
    ServerName example.com # edit here!

    RequestHeader set "X-Forwarded-Proto" expr=%{REQUEST_SCHEME}
    AllowEncodedSlashes NoDecode
    ProxyPass /_matrix http://127.0.0.1:8008/_matrix nocanon
    ProxyPassReverse /_matrix http://127.0.0.1:8008/_matrix
</VirtualHost>


'''CONTENT'''



